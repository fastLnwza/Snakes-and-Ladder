name: Build and Package for itch.io

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to build (all, windows, macos)'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - windows
          - macos

jobs:
  build-windows:
    name: Build Windows
    runs-on: windows-latest
    if: github.event.inputs.platform == 'all' || github.event.inputs.platform == 'windows' || github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install vcpkg
        run: |
          git clone https://github.com/Microsoft/vcpkg.git C:\vcpkg
          C:\vcpkg\bootstrap-vcpkg.bat
          echo "VCPKG_ROOT=C:\vcpkg" >> $env:GITHUB_ENV
      
      - name: Install SDL2_mixer via vcpkg
        run: |
          C:\vcpkg\vcpkg.exe install sdl2-mixer:x64-windows
          echo "Checking installed files..."
          dir C:\vcpkg\installed\x64-windows\include\SDL2
          dir C:\vcpkg\installed\x64-windows\lib\SDL2*
      
      - name: Configure CMake
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release `
            -DCMAKE_TOOLCHAIN_FILE=C:\vcpkg\scripts\buildsystems\vcpkg.cmake `
            -DVCPKG_TARGET_TRIPLET=x64-windows 2>&1 | Tee-Object -FilePath cmake_output.log
          $CMAKE_EXIT_CODE = $LASTEXITCODE
          Write-Host "=== SDL2_mixer related messages ==="
          Select-String -Path cmake_output.log -Pattern "sdl|audio|mixer" -CaseSensitive:$false | ForEach-Object { Write-Host $_.Line }
          Write-Host "=== Final CMake status ==="
          Get-Content cmake_output.log -Tail 30
          if ($CMAKE_EXIT_CODE -ne 0) {
            Write-Host "CMake configure failed with exit code $CMAKE_EXIT_CODE"
            exit $CMAKE_EXIT_CODE
          }
          Write-Host "CMake configure completed successfully"
      
      - name: Build
        run: |
          cmake --build build --config Release
      
      - name: Create Windows package
        run: |
          mkdir itch_package_windows
          copy build\Release\SnakesAndLadder.exe itch_package_windows\
          xcopy /E /I shaders itch_package_windows\shaders
          xcopy /E /I assets itch_package_windows\assets
          if exist build\pixel-game.regular.otf copy build\pixel-game.regular.otf itch_package_windows\
          if exist assets\fonts\pixel-game.regular.otf copy assets\fonts\pixel-game.regular.otf itch_package_windows\
      
      - name: Copy DLLs
        run: |
          # Copy SDL2 DLLs from vcpkg
          if exist "C:\vcpkg\installed\x64-windows\bin\SDL2.dll" (
            copy "C:\vcpkg\installed\x64-windows\bin\SDL2.dll" itch_package_windows\
            copy "C:\vcpkg\installed\x64-windows\bin\SDL2_mixer.dll" itch_package_windows\
          ) else (
            echo Warning: SDL2 DLLs not found, game may not run without them
          )
      
      - name: Create README
        run: |
          echo Snakes and Ladders 3D - Windows > itch_package_windows\README.txt
          echo. >> itch_package_windows\README.txt
          echo HOW TO RUN: >> itch_package_windows\README.txt
          echo 1. Double-click SnakesAndLadder.exe to launch the game >> itch_package_windows\README.txt
          echo 2. If Windows Defender blocks it, click "More info" then "Run anyway" >> itch_package_windows\README.txt
          echo. >> itch_package_windows\README.txt
          echo CONTROLS: >> itch_package_windows\README.txt
          echo - Space: Roll dice / Confirm actions >> itch_package_windows\README.txt
          echo - +/-: Adjust volume >> itch_package_windows\README.txt
          echo - T: Debug teleport mode >> itch_package_windows\README.txt
          echo. >> itch_package_windows\README.txt
          echo SYSTEM REQUIREMENTS: >> itch_package_windows\README.txt
          echo - Windows 10 or later >> itch_package_windows\README.txt
          echo - OpenGL 3.3+ compatible graphics card >> itch_package_windows\README.txt
      
      - name: Create ZIP
        run: |
          powershell Compress-Archive -Path itch_package_windows\* -DestinationPath SnakesAndLadders3D_windows_v${{ github.ref_name }}.zip -Force
      
      - name: Upload Windows artifact
        uses: actions/upload-artifact@v4
        with:
          name: windows-build
          path: SnakesAndLadders3D_windows_*.zip

  build-macos:
    name: Build macOS
    runs-on: macos-latest
    if: github.event.inputs.platform == 'all' || github.event.inputs.platform == 'macos' || github.event_name == 'push'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Install SDL2_mixer
        run: |
          brew install sdl2_mixer
          echo "Checking installed files..."
          ls -la /opt/homebrew/include/SDL2/ 2>/dev/null || ls -la /usr/local/include/SDL2/ 2>/dev/null || echo "SDL2 include not found"
      
      - name: Configure CMake
        run: |
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_CXX_FLAGS="-Wno-deprecated-copy" 2>&1 | tee cmake_output.log
          CMAKE_EXIT_CODE=${PIPESTATUS[0]}
          echo "=== SDL2_mixer related messages ==="
          grep -i "sdl\|audio\|mixer" cmake_output.log || echo "No SDL2_mixer messages found"
          echo "=== Final CMake status ==="
          tail -30 cmake_output.log
          if [ $CMAKE_EXIT_CODE -ne 0 ]; then
            echo "CMake configure failed with exit code $CMAKE_EXIT_CODE"
            exit $CMAKE_EXIT_CODE
          fi
          echo "CMake configure completed successfully"
      
      - name: Build
        run: |
          cmake --build build --config Release
      
      - name: Create macOS package
        run: |
          mkdir -p itch_package_mac/SnakesAndLadders3D.app/Contents/MacOS
          mkdir -p itch_package_mac/SnakesAndLadders3D.app/Contents/Resources
          
          cp build/SnakesAndLadder itch_package_mac/SnakesAndLadders3D.app/Contents/MacOS/SnakesAndLadders3D
          chmod +x itch_package_mac/SnakesAndLadders3D.app/Contents/MacOS/SnakesAndLadders3D
          
          cp -r build/shaders itch_package_mac/SnakesAndLadders3D.app/Contents/Resources/
          cp -r assets itch_package_mac/SnakesAndLadders3D.app/Contents/Resources/
          
          if [ -f "build/pixel-game.regular.otf" ]; then
            cp build/pixel-game.regular.otf itch_package_mac/SnakesAndLadders3D.app/Contents/Resources/
          elif [ -f "assets/fonts/pixel-game.regular.otf" ]; then
            cp assets/fonts/pixel-game.regular.otf itch_package_mac/SnakesAndLadders3D.app/Contents/Resources/
          fi
          
          # Create Info.plist
          cat > itch_package_mac/SnakesAndLadders3D.app/Contents/Info.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>CFBundleExecutable</key>
              <string>SnakesAndLadders3D</string>
              <key>CFBundleIdentifier</key>
              <string>com.snakesandladders3d</string>
              <key>CFBundleName</key>
              <string>SnakesAndLadders3D</string>
              <key>CFBundleVersion</key>
              <string>${{ github.ref_name }}</string>
              <key>CFBundleShortVersionString</key>
              <string>${{ github.ref_name }}</string>
              <key>CFBundlePackageType</key>
              <string>APPL</string>
              <key>LSMinimumSystemVersion</key>
              <string>10.13</string>
              <key>NSHighResolutionCapable</key>
              <true/>
          </dict>
          </plist>
          EOF
      
      - name: Create README
        run: |
          cat > itch_package_mac/README.txt << EOF
          Snakes and Ladders 3D - macOS
          
          HOW TO RUN:
          1. Double-click SnakesAndLadders3D.app to launch the game
          2. If you see a security warning, right-click the app and select "Open"
          3. You may need to allow the app in System Preferences > Security & Privacy
          
          CONTROLS:
          - Space: Roll dice / Confirm actions
          - +/-: Adjust volume
          - T: Debug teleport mode
          
          SYSTEM REQUIREMENTS:
          - macOS 10.13 or later
          - OpenGL 3.3+ compatible graphics card
          
          Enjoy the game!
          EOF
      
      - name: Create ZIP
        run: |
          cd itch_package_mac
          zip -r ../SnakesAndLadders3D_mac_v${{ github.ref_name }}.zip SnakesAndLadders3D.app README.txt
          cd ..
      
      - name: Upload macOS artifact
        uses: actions/upload-artifact@v4
        with:
          name: macos-build
          path: SnakesAndLadders3D_mac_*.zip

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build-windows, build-macos]
    if: github.event_name == 'push'
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: Create or Update Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref_name }}
          files: |
            windows-build/*.zip
            macos-build/*.zip
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

